<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAP Cloud Integration XSLT Editor - Monaco Editor</title>

    <link rel="stylesheet" href="style.css">


</head>
<body>

<header>
    <div class="logo">SAP Cloud Integration XSLT Editor</div>
</header>

<div class="toolbar">
    <select id="example-select">
        <option value="">üìö Choose an Example...</option>
        <option value="basic">Basic XML to XML</option>
        <option value="html">XML to HTML Table</option>
        <option value="filter">Data Filtering</option>
        <option value="group">Grouping Example</option>
        <option value="json">JSON-like Output</option>
        <option value="complex">Complex Document</option>
    </select>
    <button id="run-btn">‚ñ∂Ô∏è RUN TRANSFORMATION</button>
    <button class="btn-sec" onclick="formatAll()">‚ú® PRETTIFY CODE</button>
    <button class="btn-sec" onclick="downloadResult()">üíæ DOWNLOAD</button>
</div>

<div class="main-layout">
    <div class="editor-box">
        <div class="label">XML Input</div>
        <div id="xml-editor" class="editor-container"></div>
    </div>
    <div class="editor-box">
        <div class="label">XSLT 3.0 Stylesheet</div>
        <div id="xslt-editor" class="editor-container"></div>
    </div>
    <div id="result-panel">
        <div class="label">Output</div>
        <div id="output-editor" class="editor-container"></div>
    </div>
</div>

<script src="lib/SaxonJS2.js"></script>
<script src="lib/examples.js"></script>

<script type="module">
    import * as monaco from 'https://cdn.jsdelivr.net/npm/monaco-editor@0.55.1/+esm';

    let xmlEditor, xsltEditor, outputEditor;

    // Wait for DOM to be ready before initializing Monaco
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded, initializing Monaco Editor...');

        // Define custom theme to match the dark design
        monaco.editor.defineTheme('custom-dark', {
            base: 'vs-dark',
            inherit: true,
            rules: [
                { token: 'comment', foreground: '64748b' },
                { token: 'keyword', foreground: 'c792ea' },
                { token: 'string', foreground: 'c3e88d' },
                { token: 'number', foreground: 'f78c6c' }
            ],
            colors: {
                'editor.background': '#1a1a2e',
                'editor.foreground': '#e2e8f0',
                'editor.lineHighlightBackground': '#16213e',
                'editor.selectionBackground': '#334155',
                'editorCursor.foreground': '#6366f1'
            }
        });

        initializeEditors();
    });

    function initializeEditors() {
        console.log('Initializing Monaco editors...');

        // Check if SaxonJS2.js loaded correctly
        if (typeof SaxonJS === 'undefined') {
            console.error("Library not found in /lib/SaxonJS2.js");
            return;
        }

        // Setup Monaco Editors with default values
        const xmlOptions = {
            value: `<?xml version="1.0" encoding="UTF-8"?>
<data>
    <user id="1" role="admin">Alice</user>
    <user id="2" role="editor">Bob</user>
</data>`,
            language: 'xml',
            theme: 'custom-dark',
            fontSize: 14,
            fontFamily: "'Fira Code', 'JetBrains Mono', 'Consolas', monospace",
            lineNumbers: 'on',
            roundedSelection: false,
            scrollBeyondLastLine: false,
            automaticLayout: true,
            minimap: { enabled: false },
            wordWrap: 'on',
            tabSize: 2,
            insertSpaces: true
        };

        const xsltOptions = {
            value: `<?xml version="1.0" encoding="UTF-8"?>
<xsl:stylesheet xmlns:xsl="http://www.w3.org/1999/XSL/Transform" version="3.0">
    <xsl:output method="xml" indent="yes"/>

    <xsl:template match="/">
        <report date="{current-date()}">
            <xsl:apply-templates select="//user"/>
        </report>
    </xsl:template>

    <xsl:template match="user">
        <entry name="{.}" type="{@role}"/>
    </xsl:template>
</xsl:stylesheet>`,
            language: 'xml',
            theme: 'custom-dark',
            fontSize: 14,
            fontFamily: "'Fira Code', 'JetBrains Mono', 'Consolas', monospace",
            lineNumbers: 'on',
            roundedSelection: false,
            scrollBeyondLastLine: false,
            automaticLayout: true,
            minimap: { enabled: false },
            wordWrap: 'on',
            tabSize: 2,
            insertSpaces: true
        };

        const outputOptions = {
            value: "Press Run to see results...",
            language: 'xml',
            theme: 'custom-dark',
            fontSize: 14,
            fontFamily: "'Fira Code', 'JetBrains Mono', 'Consolas', monospace",
            lineNumbers: 'on',
            roundedSelection: false,
            scrollBeyondLastLine: false,
            automaticLayout: true,
            minimap: { enabled: false },
            wordWrap: 'on',
            tabSize: 2,
            insertSpaces: true,
            readOnly: true
        };

        console.log('Creating XML editor...');
        xmlEditor = monaco.editor.create(document.getElementById('xml-editor'), xmlOptions);
        console.log('Creating XSLT editor...');
        xsltEditor = monaco.editor.create(document.getElementById('xslt-editor'), xsltOptions);
        console.log('Creating output editor...');
        outputEditor = monaco.editor.create(document.getElementById('output-editor'), outputOptions);

        // Add keyboard shortcuts
        xmlEditor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.Enter, () => {
            document.getElementById('run-btn').click();
        });
        xsltEditor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.Enter, () => {
            document.getElementById('run-btn').click();
        });

        console.log('Monaco editors initialized with default demo data');

        // The Transformation Logic
        document.getElementById('run-btn').addEventListener('click', async () => {
            const runBtn = document.getElementById('run-btn');
            const originalText = runBtn.textContent;

            // Add loading state
            runBtn.textContent = "‚è≥ PROCESSING...";
            runBtn.disabled = true;
            runBtn.classList.add('loading');

            outputEditor.setValue("üîÑ Transforming XML...");

            try {
                const result = SaxonJS.XPath.evaluate(`
                    transform(map {
                        'stylesheet-text' : $xslt,
                        'source-node' : parse-xml($xml),
                        'delivery-format' : 'serialized'
                    })?output`,
                    [],
                    {
                        params: {
                            xslt: xsltEditor.getValue(),
                            xml: xmlEditor.getValue()
                        }
                    }
                );

                outputEditor.setValue(result);

            } catch (err) {
                console.error(err);
                outputEditor.setValue("‚ùå Transformation Error:\n" + err.message);
            } finally {
                // Reset button state
                runBtn.textContent = originalText;
                runBtn.disabled = false;
                runBtn.classList.remove('loading');
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey || e.metaKey) {
                switch (e.key) {
                    case 's':
                        e.preventDefault();
                        downloadResult();
                        break;
                    case 'p':
                        e.preventDefault();
                        formatAll();
                        break;
                }
            }
        });

        // Example selector
        document.getElementById('example-select').addEventListener('change', (e) => {
            const selectedExample = e.target.value;
            if (selectedExample && examples[selectedExample]) {
                xmlEditor.setValue(examples[selectedExample].xml);
                xsltEditor.setValue(examples[selectedExample].xslt);
                outputEditor.setValue("Example loaded! Press Run to see results...");
            }
        });
    }

    // Formatting Tool
    function formatAll() {
        const format = (v) => v.replace(/>\s*</g, '><').replace(/<([^?\/!][^>]*?)\/>/g, '<$1 />').replace(/>(?=<)/g, '>\n');
        xmlEditor.setValue(format(xmlEditor.getValue()));
        xsltEditor.setValue(format(xsltEditor.getValue()));
    }

    // Download Tool
    function downloadResult() {
        const text = outputEditor.getValue();
        const blob = new Blob([text], {type: "text/xml"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = "result.xml";
        a.click();
    }
</script>

</body>
</html>
