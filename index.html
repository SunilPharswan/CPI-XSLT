<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAP Cloud Integration XSLT Editor</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/theme/material.min.css">
    <link rel="stylesheet" href="style.css">


</head>
<body>

<header>
    <div class="logo">SAP Cloud Integration XSLT Editor</div>
</header>

<div class="toolbar">
    <select id="example-select">
        <option value="">üìö Choose an Example...</option>
        <option value="basic">Basic XML to XML</option>
        <option value="html">XML to HTML Table</option>
        <option value="filter">Data Filtering</option>
        <option value="group">Grouping Example</option>
        <option value="json">JSON-like Output</option>
        <option value="complex">Complex Document</option>
    </select>
    <button id="run-btn">‚ñ∂Ô∏è RUN TRANSFORMATION</button>
    <button class="btn-sec" onclick="formatAll()">‚ú® PRETTIFY CODE</button>
    <button class="btn-sec" onclick="downloadResult()">üíæ DOWNLOAD</button>
</div>

<div class="main-layout">
    <div class="editor-box">
        <div class="label">XML Input</div>
        <textarea id="xml-input"></textarea>
    </div>
    <div class="editor-box">
        <div class="label">XSLT 3.0 Stylesheet</div>
        <textarea id="xslt-input"></textarea>
    </div>
    <div id="result-panel">
        <div class="label">Output</div>
        <textarea id="output-text" readonly>Press Run to see results...</textarea>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/xml/xml.min.js"></script>

<script src="lib/SaxonJS2.js"></script>
<script src="lib/examples.js"></script>

<script>
    let xmlEditor, xsltEditor, outputEditor;

    document.addEventListener('DOMContentLoaded', () => {
        // 1. Check if SaxonJS2.js loaded correctly
        if (typeof SaxonJS === 'undefined') {
            console.error("Library not found in /lib/SaxonJS2.js");
            return;
        }

        // 2. Setup Editors
        const cmConfig = {
            mode: 'xml',
            lineNumbers: true,
            theme: 'material',
            viewportMargin: Infinity,
            extraKeys: {
                "Ctrl-Enter": function() { document.getElementById('run-btn').click(); }
            }
        };

        const outputConfig = {
            mode: 'xml',
            lineNumbers: true,
            theme: 'material',
            viewportMargin: Infinity,
            readOnly: true
        };

        xmlEditor = CodeMirror.fromTextArea(document.getElementById('xml-input'), cmConfig);
        xsltEditor = CodeMirror.fromTextArea(document.getElementById('xslt-input'), cmConfig);
        outputEditor = CodeMirror.fromTextArea(document.getElementById('output-text'), outputConfig);

        // 3. Default Demo Data
        xmlEditor.setValue(`<?xml version="1.0" encoding="UTF-8"?>
<data>
    <user id="1" role="admin">Alice</user>
    <user id="2" role="editor">Bob</user>
</data>`);

        xsltEditor.setValue(`<?xml version="1.0" encoding="UTF-8"?>
<xsl:stylesheet xmlns:xsl="http://www.w3.org/1999/XSL/Transform" version="3.0">
    <xsl:output method="xml" indent="yes"/>

    <xsl:template match="/">
        <report date="{current-date()}">
            <xsl:apply-templates select="//user"/>
        </report>
    </xsl:template>

    <xsl:template match="user">
        <entry name="{.}" type="{@role}"/>
    </xsl:template>
</xsl:stylesheet>`);

        // 4. The Transformation Logic (The Fix for JSON error)
        document.getElementById('run-btn').addEventListener('click', async () => {
            const runBtn = document.getElementById('run-btn');
            const originalText = runBtn.textContent;

            // Add loading state
            runBtn.textContent = "‚è≥ PROCESSING...";
            runBtn.disabled = true;
            runBtn.classList.add('loading');

            outputEditor.setValue("üîÑ Transforming XML...");

            try {
                /* Using the XPath transform() function is the most reliable
                   way to handle dynamic XSLT strings in the browser.
                */
                const result = SaxonJS.XPath.evaluate(`
                    transform(map {
                        'stylesheet-text' : $xslt,
                        'source-node' : parse-xml($xml),
                        'delivery-format' : 'serialized'
                    })?output`,
                    [],
                    {
                        params: {
                            xslt: xsltEditor.getValue(),
                            xml: xmlEditor.getValue()
                        }
                    }
                );

                outputEditor.setValue(result);

                // Show success message temporarily
                setTimeout(() => {
                    // Color is handled by CodeMirror theme
                }, 2000);

            } catch (err) {
                console.error(err);
                outputEditor.setValue("‚ùå Transformation Error:\n" + err.message);
            } finally {
                // Reset button state
                runBtn.textContent = originalText;
                runBtn.disabled = false;
                runBtn.classList.remove('loading');
            }
        });

        // 5. Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey || e.metaKey) {
                switch (e.key) {
                    case 'Enter':
                        e.preventDefault();
                        document.getElementById('run-btn').click();
                        break;
                    case 's':
                        e.preventDefault();
                        downloadResult();
                        break;
                    case 'p':
                        e.preventDefault();
                        formatAll();
                        break;
                }
            }
        });

        // 6. Example selector
        document.getElementById('example-select').addEventListener('change', (e) => {
            const selectedExample = e.target.value;
            if (selectedExample && examples[selectedExample]) {
                xmlEditor.setValue(examples[selectedExample].xml);
                xsltEditor.setValue(examples[selectedExample].xslt);
                outputEditor.setValue("Example loaded! Press Run to see results...");
            }
        });

        // 7. Auto-resize editors on window resize
        window.addEventListener('resize', () => {
            if (xmlEditor) xmlEditor.refresh();
            if (xsltEditor) xsltEditor.refresh();
            if (outputEditor) outputEditor.refresh();
        });
    });

    // Formatting Tool
    function formatAll() {
        const format = (v) => v.replace(/>\s*</g, '><').replace(/<([^?\/!][^>]*?)\/>/g, '<$1 />').replace(/>(?=<)/g, '>\n');
        xmlEditor.setValue(format(xmlEditor.getValue()));
        xsltEditor.setValue(format(xsltEditor.getValue()));
    }

    // Download Tool
    function downloadResult() {
        const text = outputEditor.getValue();
        const blob = new Blob([text], {type: "text/xml"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = "result.xml";
        a.click();
    }
</script>

</body>
</html>
